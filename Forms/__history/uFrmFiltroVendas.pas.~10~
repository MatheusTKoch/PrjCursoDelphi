unit uFrmFiltroVendas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, uFrmFiltroPai, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  FireDAC.Comp.Client, Data.DB, FireDAC.Comp.DataSet, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.ComCtrls;

type
  TFormFiltroVendas = class(TFormFiltroPai)
    edtData1: TDateTimePicker;
    edtData2: TDateTimePicker;
    Label2: TLabel;
    edtCodigoVenda: TEdit;
    Label3: TLabel;
    cbFaturado: TCheckBox;
  private
    { Private declarations }
    procedure Filtrar;
  public
    { Public declarations }
  end;

var
  FormFiltroVendas: TFormFiltroVendas;

implementation

{$R *.dfm}

{ TFormFiltroVendas }

procedure TFormFiltroVendas.Filtrar;
begin
  fdQryFiltro.Close;
  fdQryFiltro.SQL.Clear;
  fdQryFiltro.SQL.Add(' SELECT V.ID_VENDA_CAB,');
  fdQryFiltro.SQL.Add(' V.ID_CLIENTE,');
  fdQryFiltro.SQL.Add(' DECODE (C.TIPO_FJ, ''F'', C.NOME, C.RAZAO_SOCIAL) CLIENTE,');
  fdQryFiltro.SQL.Add(' V.DATA,');
  fdQryFiltro.SQL.Add(' COALESCE(V.FATURADO, ''N'') FATURADO');
  fdQryFiltro.SQL.Add(' FROM VENDA_CAB V INNER JOIN CLIENTE C ON C.ID_CLIENTE = V.ID_CLIENTE');
  fdQryFiltro.SQL.Add(' WHERE 1=1');

  if Trim(edtFiltro.Text) <> '' then
  begin
    fdQryFiltro.SQL.Add(' AND TRIM(UPPER(DECODE(C.TIPO_FJ, ''F'', C.NOME, C.RAZAO_SOCIAL))) LIKE '+ QuotedStr('%' + UpperCase(Trim(edtFiltro.Text) + '%')));
  end;

  if edtData1.Date > 0 then
  begin
    fdQryFiltro.SQL.Add(' AND V.DATA >= ' + QuotedStr(FormatDateTime('dd.mm.yyyy', edtData1.Date)));
  end;

  if edtData2.Date > 0 then
  begin
    fdQryFiltro.SQL.Add(' AND V.DATA <= ' + QuotedStr(FormatDateTime('dd.mm.yyyy', edtData2.Date)));
  end;

end;

end.
